<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Created by htmlize-1.16 in css mode. -->
<html>
  <head>
    <title>m6-frame-manipulation-primitives.lisp</title>
    <style type="text/css">
    <!--
      body {
        color: #f5deb3;
        background-color: #000000;
      }
      .comment {
        /* font-lock-comment-face */
        color: #ff7f24;
      }
      .function-name {
        /* font-lock-function-name-face */
        color: #87cefa;
      }
      .keyword {
        /* font-lock-keyword-face */
        color: #00ffff;
      }
      .string {
        /* font-lock-string-face */
        color: #ffa07a;
      }
      a {
        color: inherit;
        background-color: inherit;
        font: inherit;
        text-decoration: inherit;
      }
      a:hover {
        text-decoration: underline;
      }
    -->
    </style>
  </head>
  <body>
    <pre>
(<span class="keyword">in-package</span> <span class="string">"M6"</span>)
(include-book <span class="string"><a href="m6-type-value.lisp.html">"../M6/m6-type-value"</a></span>)
(include-book <span class="string"><a href="m6-thread.lisp.html">"../M6/m6-thread"</a></span>)
(acl2::set-verify-guards-eagerness 0)
(include-book <span class="string"><a href="../M6-DJVM-shared/jvm-frame-manipulation-primitives.lisp.html">"../M6-DJVM-shared/jvm-frame-manipulation-primitives"</a></span>)


<span class="comment">;; (defun topStack (s)
;;   (top (operand-stack (current-frame s))))
</span>

<span class="comment">;; (defun secondStack (s)
;;   (topStack (popStack s)))
</span>
(<span class="keyword">defun</span> <span class="function-name">thirdStack</span> (s)
  (topStack (popStack (popStack s))))


(<span class="keyword">defun</span> <span class="function-name">fourthStack</span> (s)
  (topStack (popStack (popStack (popStack s)))))


(<span class="keyword">defun</span> <span class="function-name">fifthStack</span> (s)
  (topStack (popStack (popStack (popStack (popStack s))))))


(<span class="keyword">defun</span> <span class="function-name">popStackN</span> (n s)
  (<span class="keyword">if</span> (zp n)
      s
    (popStackN (- n 1) (popStack s))))


(<span class="keyword">defun</span> <span class="function-name">pushLong</span> (v s)
  (pushStack v (pushStack 'topx s)))

<span class="comment">;; push 'topx then push v. :Thu Jan 15 21:17:00 2004
;; OK. 
;;
;; reverse the order of Long representation Thu Jan 15 21:23:47 2004
;;;
;;; does it comply with the current BCV representation?? No. Mon Jan 31
;;; 15:40:14 2005. 
;;; 
;;; BCV representation is fixed by StackMap generated by static checker.
;;; Mon Jan 31 15:42:27 2005
</span>
<span class="comment">;; Decision, shall we just fix how the mapping from <a href="../DJVM/djvm-state.lisp.html">djvm-state</a> to sig-state?
;; Yes. Let me do that. Mon Jan 31 15:43:05 2005
;;;
;; Fixed already in Dec. 2004. Mon Jan 31 15:44:56 2005
;;
</span>
(<span class="keyword">defun</span> <span class="function-name">popLong</span> (s)
  (popStack (popStack s)))

(<span class="keyword">defun</span> <span class="function-name">topLong</span>  (s)    
  (topStack s))


<span class="comment">;-- <a href="../common/primitives.lisp.html">primitives</a> for executing the method.
</span>
<span class="comment">;; FRAME operation
</span>
<span class="comment">;; We will rely on guard verification! 
</span>

<span class="comment">;; (defun pushFrame0 (new-frame s)
;;   (let* ((curthread-id     (current-thread s))
;;          (old-thread-table (thread-table s))
;;          (old-thread (thread-by-id curthread-id old-thread-table))
;;          (old-call-stack (thread-call-stack old-thread))
;;          (new-call-stack (push new-frame old-call-stack))
;;          (new-pc         0) ;; set new pc
;;          (new-thread    (thread-set-call-stack new-call-stack old-thread))
;;          (new-thread-table (replace-thread-table-entry old-thread 
;;                                                        new-thread 
;;                                                        old-thread-table)))
;;     (state-set-pc new-pc (state-set-thread-table new-thread-table s))))
</span>

<span class="comment">;; (defun pushFrame (method-ptr initial-locals s)
;;  (let* ((new-operand-stack (make-init-operand-stack))
;;         (return-pc    (pc s))
;;         (new-frame    (make-frame return-pc new-operand-stack initial-locals
;;                                   method-ptr -1)))
;;    (pushFrame0 new-frame s)))
</span>




<span class="comment">;; (defun popFrame (s)
;;  (let* ((curthread-id  (current-thread s))
;;         (old-thread-table (thread-table s))
;;         (old-thread     (thread-by-id curthread-id old-thread-table))
;;         (old-call-stack (thread-call-stack old-thread))
;;         (new-pc         (return-pc (top old-call-stack)))
;;         (new-call-stack (pop old-call-stack))
;;         (new-thread     (thread-set-call-stack new-call-stack old-thread))
;;         (new-thread-table (replace-thread-table-entry old-thread 
;;                                                       new-thread 
;;                                                       old-thread-table)))
;;    (state-set-pc new-pc (state-set-thread-table new-thread-table s))))
</span>
<span class="comment">;; do nothing if invoked on illegal input. maybe I should add some
;; output to indicate guard violation.
</span>
(<span class="keyword">defun</span> <span class="function-name">build-initial-local1</span> (rev-arg-types operand-stack)
  (<span class="keyword">if</span> (endp rev-arg-types)
      nil
    (<span class="keyword">if</span> (equal (type-size (car rev-arg-types)) 2)
        (cons 'topx (cons (top (pop operand-stack))  
           <span class="comment">;; assuming in locals, a Long value is stored in the first slot.
</span>                         (build-initial-local1 (cdr rev-arg-types) (pop (pop
                                                                         operand-stack)))))
      (cons (top operand-stack) (build-initial-local1 (cdr rev-arg-types) (pop operand-stack))))))
      

(<span class="keyword">defun</span> <span class="function-name">fill-top</span> (n)
  (<span class="keyword">if</span> (zp n) nil
    (cons 'topx (fill-top (- n 1)))))

(<span class="keyword">defun</span> <span class="function-name">size-of-param</span> (arg-types)
  (<span class="keyword">if</span> (endp arg-types)
      0
    (<span class="keyword">if</span> (equal (type-size (car arg-types)) 2)
        (+ 2 (size-of-param (cdr arg-types)))
      (+ 1 (size-of-param (cdr arg-types))))))
  

(<span class="keyword">defun</span> <span class="function-name">build-initial-local</span> (arg-types operand-stack length)
  (<span class="keyword">let*</span> ((reversed-params (build-initial-local1 (reverse arg-types)
                                                operand-stack))
         (reversed-locals (app (fill-top (- length (len reversed-params)))
                               reversed-params)))
    (reverse reversed-locals)))

<span class="comment">; need to fix this!! Mon Oct 25 16:30:21 2004
; We need all slot being preallocated!!
</span>


<span class="comment">; <a href="../common/primitives.lisp.html">primitives</a> for how to get a method-ptr to store in the call frame
</span>(<span class="keyword">defun</span> <span class="function-name">method-rep-to-method-ptr</span> (method-rep)
  (make-method-ptr (method-classname method-rep)
                   (method-methodname method-rep)
                   (method-args       method-rep)
                   (method-returntype method-rep)))



(<span class="keyword">defun</span> <span class="function-name">pushFrameWithPop</span> (obj-ref method-rep s)
  (<span class="keyword">let*</span> ((args       (method-args method-rep))
         (method-ptr (method-rep-to-method-ptr method-rep))
         (locals     (build-initial-local (method-args method-rep)
                                          (operand-stack (current-frame s))
                                          (method-maxlocals method-rep)))
         (accessflags (method-accessflags method-rep)))
    (<span class="keyword">if</span> (mem '*static* accessflags) <span class="comment">;; no this pointer
</span>        (pushFrame method-ptr locals 
                   (popStackN (size-of-param args) s))
      (pushFrame method-ptr (cons obj-ref locals) (popStackN (+ (size-of-param
                                                                 args) 1) s)))))


<span class="comment">;--- 
</span>







</pre>
  </body>
</html>
